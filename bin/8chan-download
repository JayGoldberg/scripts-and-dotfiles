#!/bin/sh
thread=${1?Please supply a thread URL to download}
thread=${thread%%#*}
[ "$thread" != "${thread%html}" ] && thread=${thread%html}json

board=${thread%%/res/*}; board=${board##*/}
base_url=https://media.8ch.net/$board/src/

wget -O - --quiet -- "$thread" |
  jq -r '[.posts[], .posts[].extra_files[]?][] | select(.tim and .filename and .ext) | .tim, .filename + .ext, .tim + .ext' |
  while IFS= read -r time && IFS= read -r file && IFS= read -r file_mangled; do
    file=${file##*/}
    if [ -s "${time}_$file" ]
    then echo "Skipping ${time}_$file"
    else wget --quiet --show-progress -O "${time}_$file" "$base_url$file_mangled"
    fi
  done
