#!/bin/sh
poll_interval=2
poll_url=192.168.1.1/api/monitoring/status
signal_bars_tag=SignalIcon
battery_percent_tag=BatteryPercent
charging_tag=BatteryStatus

signal=0
battery=0
charging=0

get_xml_line() {
    # get_xml_line "$line" "tagname"
    line=${1##*<$2>}
    echo ${line%%</$2>*}
}

print_bar() {
    # print_bar label progress
    printf '\033[0;1m%-9s\033[92m' "$1:"
    for x in $(seq 1 "$2"); do printf '#'; done
    printf '\033[91m'
    for x in $(seq "$2" 9); do printf '#'; done
}

while :; do
    raw=$(curl -s -- "$poll_url") || { sleep "$poll_interval"; continue; }
    while read line; do
        case "$line" in
            "<$signal_bars_tag>"*)
                signal=$(get_xml_line "$line" "$signal_bars_tag");;
            "<$battery_percent_tag>"*)
                battery=$(get_xml_line "$line" "$battery_percent_tag");;
            "<$charging_tag>"*)
                charging=$(get_xml_line "$line" "$charging_tag");;
        esac
    done << EOF
$raw
EOF
    echo
    print_bar Signal "$((signal * 2))"
    echo
    print_bar Battery "$((battery / 10))"
    [ "$charging" != 0 ] && printf '\033[0m+'
    # No newline printed here, otherwise you have to resize the terminal to 3 lines long to see it properly!

    sleep "$poll_interval"
done
